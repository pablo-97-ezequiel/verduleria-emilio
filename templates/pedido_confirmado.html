{% extends "base.html" %}
{% block content %}

<div class="alert alert-success d-flex align-items-center gap-2">
  <span class="fs-4">âœ…</span>
  <div>Confirma tu pedido por WhatsApp</div>
</div>

<div class="card shadow-sm">
  <div class="card-body">

    <p><strong>NÃºmero de pedido:</strong> {{ numero_pedido }}</p>
    <p><strong>Fecha y hora:</strong> {{ fecha }}</p>
    <p><strong>Cliente:</strong> {{ nombre }} ({{ telefono }})</p>

    {% if place == "retiro" %}
      <p><strong>Retiro en el local:</strong> {{ retiro }}</p>
    {% else %}
      <p><strong>ðŸšš Delivery a:</strong> {{ delivery_address }}</p>
    {% endif %}

    <p><strong>MÃ©todo de pago:</strong> {{ pago }}</p>
    <p><strong>Nota:</strong> {{ nota if nota else "Sin notas" }}</p>

    <h5 class="mt-3">ðŸ›’ Productos</h5>
    <ul class="list-unstyled">
      {% for item in productos %}
        <li>
          {{ item.qty|fraccion }} {{ 'Kg' if item.unit == 'kg' else 'u' }} de {{ item.name }}
          {% if item.promo_price %}
            <span class="badge bg-warning text-dark ms-1">PROMO</span>
          {% endif %}
          = ${{ '%.2f'|format(item.line_total) }}
        </li>
      {% endfor %}
    </ul>

    <h4 class="mt-3">ðŸ’° Total: ${{ '%.2f'|format(total) }}</h4>


<!-- ===================================================== -->
<!-- MÃ‰TODOS DE PAGO - FINAL Y SIN ERRORES DE SINTAXIS -->
<!-- ===================================================== -->

{% if "Mercado Pago" in pago and "Online" in pago %}

<div class="text-center mt-4">

  <h5 class="fw-bold">PagÃ¡ tu pedido con Mercado Pago</h5>

  <div class="alert alert-info">
    Alias para pagar: <strong class="text-primary">peg1234567</strong><br>
    <small>Copialo y pegalo en tu app de Mercado Pago.</small>
  </div>

  <button class="btn btn-outline-primary w-100 mb-2"
          onclick="navigator.clipboard.writeText('peg1234567'); alert('Alias copiado âœ”');">
    ðŸ“‹ Copiar alias de Mercado Pago
  </button>

  <button class="btn w-100"
          style="background:#009ee3;color:white;"
          onclick="window.open('https://www.mercadopago.com.ar', '_blank');">
    ðŸ”µ Abrir Mercado Pago
  </button>

  <p class="text-muted mt-2" style="font-size:0.9rem;">
    Este botÃ³n solo abre tu app.  
    Luego pegÃ¡ el alias para completar el pago.
  </p>

</div>

{% elif "Cuenta DNI" in pago and "Online" in pago %}

<div class="text-center mt-4">

  <h5 class="fw-bold">PagÃ¡ tu pedido con Cuenta DNI</h5>

  <div class="alert alert-info">
    Alias para pagar: <strong class="text-success">ejemplo.dni</strong><br>
    <small>Copialo y pegalo en tu app de Cuenta DNI.</small>
  </div>

  <button class="btn btn-outline-success w-100 mb-2"
          onclick="navigator.clipboard.writeText('ejemplo.dni'); alert('Alias copiado âœ”');">
    ðŸ“‹ Copiar alias de Cuenta DNI
  </button>

  <button class="btn w-100"
        style="background:#00a65a;color:white;"
        onclick="window.location.href='bnppersonas://cuentadni'; 
                 setTimeout(() => { 
                   window.open('https://www.bancoprovincia.com.ar/web/cuentadni', '_blank'); 
                 }, 800);">
    ðŸŸ¢ Abrir Cuenta DNI
</button>


  <p class="text-muted mt-2" style="font-size:0.9rem;">
    Este botÃ³n solo abre tu app.  
    Luego pegÃ¡ el alias para completar el pago.
  </p>

</div>

{% elif "Efectivo" in pago and place == "retiro" %}

<div class="alert alert-success text-center mt-4 fw-bold">
  ðŸ’µ PagÃ¡s en efectivo al retirar tu pedido. Â¡Gracias!
</div>

{% elif "Efectivo" in pago and place == "delivery" %}

<div class="alert alert-success text-center mt-4 fw-bold">
  ðŸ’µ PagÃ¡s en efectivo al recibir el delivery. Â¡Gracias!
</div>

{% else %}

<div class="alert alert-info text-center mt-4 fw-bold">
  Pago confirmado. Â¡Gracias por tu compra!
</div>

{% endif %}


<!-- BOTONES -->
<div class="mt-4 d-flex flex-wrap gap-2 justify-content-center">

  <a class="btn btn-outline-secondary" href="{{ url_for('index') }}">
    ðŸ”™ Volver al catÃ¡logo
  </a>

  <button class="btn btn-success" onclick="enviarWppYConfirmar()">
    ðŸ’¬ Enviar por WhatsApp
  </button>

</div>

  </div>
</div>

<script>
  function enviarWppYConfirmar() {
    const orderId = {{ order_id }};
    const wppUrl = "{{ wpp_url }}";
    
    // Hacer POST a /marcar_enviado
    fetch("{{ url_for('marcar_enviado') }}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ order_id: orderId })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Abrir WhatsApp en nueva pestaÃ±a
        window.open(wppUrl, "_blank");
        alert("Pedido marcado como enviado");
      } else {
        alert("Error: " + data.error);
      }
    })
    .catch(error => {
      console.error("Error:", error);
      alert("Hubo un error al procesar tu pedido");
    });
  }
</script>

{% endblock %}
