{% extends "base.html" %}
{% block content %}
<h1 class="h3 mb-3">Datos del cliente</h1>

<div id="badge-delivery-efectivo" 
     class="alert alert-success text-center fw-bold" 
     style="display:none;">
  üíµ Pag√°s en efectivo al delivery
</div>

<style>
  body {
    background-image: url('{{ url_for("static", filename="fondo.jpg") }}');
    background-size: cover;
    background-repeat: no-repeat;
  }

  .btn-pago, .btn-lugar {
    flex: 1;
    font-size: 1rem;
    padding: 10px;
    border-radius: 8px;
    border: none;
    color: white;
    transition: 0.2s;
  }

  .btn-pago.active, .btn-lugar.active {
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    transform: scale(1.05);
  }

  .btn-pago.mp { background:#009ee3; }
  .btn-pago.dni { background:#00a650; }
  .btn-pago.efectivo { background:#6c757d; }

  .btn-lugar.local { background:#198754; }
  .btn-lugar.online { background:#0d6efd; }
</style>

{% if cart %}
<form method="post" action="{{ url_for('confirmar_pedido') }}" class="row g-3">

  <input type="hidden" id="place" name="place" value="retiro">

  <!-- DATOS -->
  <div class="col-md-6">
    <label>Nombre</label>
    <input class="form-control" name="nombre" required>
  </div>

  <div class="col-md-6">
    <label>Tel√©fono</label>
    <input class="form-control" name="telefono" required>
  </div>

  <!-- RETIRO -->
  <div class="col-md-6" id="pickupBox">
    <label>Hora exacta de retiro</label>
    <input class="form-control" type="time" id="pickup_time" name="retiro" required>
  </div>

  <!-- DELIVERY -->
  <div class="col-12">
    <button type="button" class="btn btn-warning w-100" onclick="selectPlace('delivery')">
      üõµ Delivery (sin cargo)
    </button>
  </div>

  <div id="deliveryBox" style="display:none;">
    <label>üìç Direcci√≥n de entrega</label>
    <input class="form-control" name="delivery_address" id="delivery_address">
  </div>

  <!-- M√âTODO DE PAGO -->
  <div class="col-12">
    <h5>üí≥ M√©todo de pago</h5>
    <div class="d-flex flex-wrap gap-2" id="metodo-pago">
      <button type="button" class="btn btn-pago mp" data-pago="Mercado Pago">Mercado Pago</button>
      <button type="button" class="btn btn-pago dni" data-pago="Cuenta DNI">Cuenta DNI</button>
      <button type="button" class="btn btn-pago efectivo" data-pago="Efectivo">Efectivo</button>
    </div>
  </div>

  <!-- LUGAR DE PAGO -->
  <div class="col-12">
    <h5 class="mt-2">üìç D√≥nde quer√©s pagar</h5>
    <div class="d-flex flex-wrap gap-2" id="lugar-pago">
      <button type="button" class="btn btn-lugar local" data-lugar="En el local">En el local</button>
      <button type="button" class="btn btn-lugar online" data-lugar="Online">Online</button>
    </div>
  </div>

  <p id="mensaje-confirmacion" class="text-success fw-bold mt-2" style="display:none;"></p>

  <!-- NOTA -->
  <div class="col-12">
    <label>Nota (opcional)</label>
    <textarea class="form-control" name="nota" rows="2"></textarea>
  </div>

  <!-- RESUMEN -->
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header bg-success text-white">Resumen</div>
      <div class="card-body">
        <ul class="list-group">
          {% for it in cart %}
          <li class="list-group-item d-flex justify-content-between">
            <span>{{ it.qty|fraccion }} {{ 'Kg' if it.unit=='kg' else 'u' }} {{ it.name }}</span>
            <strong>${{ '%.2f'|format(it.line_total) }}</strong>
          </li>
          {% endfor %}
        </ul>
      </div>
      <div class="card-footer d-flex justify-content-between">
        <strong>Total</strong>
        <strong>${{ '%.2f'|format(total) }}</strong>
      </div>
    </div>
  </div>

  <div class="text-end">
    <a class="btn btn-secondary" href="{{ url_for('carrito') }}">Volver</a>
    <button class="btn btn-success" type="submit" disabled>Confirmar pedido</button>
  </div>

  <input type="hidden" name="pago_final" id="pago_final">

</form>

<!-- ==========================
     JS CORREGIDO 
     ========================== -->
<script>
let pagoSeleccionado = null;
let lugarSeleccionado = null;
const msg = document.getElementById("mensaje-confirmacion");
const badge = document.getElementById("badge-delivery-efectivo");
const btnConfirm = document.querySelector('button[type="submit"]');

// =======================
// ACTUALIZAR MENSAJE
// =======================
function construirMensaje() {
  const place = document.getElementById("place").value;

  if (pagoSeleccionado === "Efectivo") {
    return place === "delivery"
      ? "üíµ Perfecto, pagar√°s en efectivo al recibir el pedido."
      : "üíµ Perfecto, pagar√°s en efectivo al retirar en el local.";
  }

  if (lugarSeleccionado === "Online")
    return `üí≥ Perfecto, pagar√°s online con ${pagoSeleccionado}.`;

  return `üè™ Perfecto, pagar√°s con ${pagoSeleccionado} en el local.`;
}

function actualizar() {
  if (!pagoSeleccionado || !lugarSeleccionado) {
    msg.style.display = "none";
    btnConfirm.disabled = true;
    return;
  }

  if (pagoSeleccionado === "Efectivo" && lugarSeleccionado === "Online") {
    msg.style.display = "block";
    msg.textContent = "‚ùå No pod√©s pagar en efectivo de forma online.";
    btnConfirm.disabled = true;
    return;
  }

  msg.style.display = "block";
  msg.textContent = construirMensaje();

  document.getElementById("pago_final").value =
    `${pagoSeleccionado} - ${lugarSeleccionado}`;

  btnConfirm.disabled = false;
}

// =======================
// M√âTODO DE PAGO
// =======================
document.querySelectorAll(".btn-pago").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll(".btn-pago").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    pagoSeleccionado = btn.dataset.pago;

    const place = document.getElementById("place").value;
    const btnLocal = document.querySelector('.btn-lugar.local');
    const btnOnline = document.querySelector('.btn-lugar.online');

    // REGLAS DEFINITIVAS
    if (place === "delivery") {
      if (pagoSeleccionado === "Efectivo") {
        btnLocal.style.display = "none";
        btnOnline.style.display = "none";
        lugarSeleccionado = "Al delivery";
        badge.style.display = "block";
      } else {
        btnLocal.style.display = "none";
        btnOnline.style.display = "block";
        badge.style.display = "none";
      }
    } else {
      badge.style.display = "none";
      btnLocal.style.display = "block";

      if (pagoSeleccionado === "Efectivo") {
        btnOnline.style.display = "none";
      } else {
        btnOnline.style.display = "block";
      }
    }

    actualizar();
  };
});

// =======================
// LUGAR DE PAGO
// =======================
document.querySelectorAll(".btn-lugar").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll(".btn-lugar").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    lugarSeleccionado = btn.dataset.lugar;
    actualizar();
  };
});

// =======================
// RETIRO / DELIVERY
// =======================
function selectPlace(tipo) {
  const pickup = document.getElementById("pickupBox");
  const delivery = document.getElementById("deliveryBox");
  const pickupInput = document.getElementById("pickup_time");
  const deliveryInput = document.getElementById("delivery_address");

  const btnLocal = document.querySelector('.btn-lugar.local');
  const btnOnline = document.querySelector('.btn-lugar.online');

  document.getElementById("place").value = tipo;

  if (tipo === "delivery") {
    pickup.style.display = "none";
    pickupInput.required = false;

    delivery.style.display = "block";
    deliveryInput.required = true;

    btnLocal.style.display = "none";
    btnOnline.style.display = "block";
    
  } else {
    pickup.style.display = "block";
    pickupInput.required = true;

    delivery.style.display = "none";
    deliveryInput.required = false;

    btnLocal.style.display = "block";
    btnOnline.style.display = "block";
  }

  badge.style.display = "none";

  pagoSeleccionado = null;
  lugarSeleccionado = null;

  document.querySelectorAll('.btn-pago, .btn-lugar').forEach(b => b.classList.remove("active"));
  actualizar();
}

btnConfirm.disabled = true;
</script>

{% else %}
<div class="alert alert-info">
  Tu carrito est√° vac√≠o. <a href="{{ url_for('index') }}">Volver al cat√°logo</a>
</div>
{% endif %}
{% endblock %}
