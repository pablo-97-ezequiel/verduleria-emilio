{% extends "base.html" %}
{% block content %}
<h1 class="h3 mb-3">Datos del cliente</h1>

<!-- === ESTILOS === -->
<style>
  body {
    background-image: url('{{ url_for("static", filename="fondo.jpg") }}');
    background-attachment: fixed;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }

  .btn-pago, .btn-lugar {
    flex: 1;
    font-size: 1rem;
    padding: 10px;
    border-radius: 8px;
    border: none;
    color: white;
    transition: all 0.2s;
  }
  .btn-pago:hover, .btn-lugar:hover { opacity: 0.9; }
  .btn-pago.active, .btn-lugar.active {
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    transform: scale(1.03);
  }
  .btn-pago.mp { background-color: #009ee3; }      /* Mercado Pago */
  .btn-pago.dni { background-color: #00a650; }     /* Cuenta DNI */
  .btn-pago.efectivo { background-color: #6c757d; }/* Efectivo */
  .btn-lugar.local { background-color: #198754; }  /* En el local */
  .btn-lugar.online { background-color: #0d6efd; } /* Online */
</style>

{% if cart %}
<form method="post" action="{{ url_for('confirmar_pedido') }}" class="row g-3">

  <!-- === DATOS DEL CLIENTE === -->
  <div class="col-12 col-md-6">
    <label class="form-label">Nombre</label>
    <input name="nombre" required class="form-control">
  </div>

  <div class="col-12 col-md-6">
    <label class="form-label">Tel√©fono</label>
    <input name="telefono" required class="form-control">
  </div>

  <div class="col-12 col-md-6">
    <label class="form-label">Hora exacta de retiro (solo hoy)</label>
    <input name="retiro" type="time" required class="form-control">
  </div>

  <!-- === M√âTODO DE PAGO INTERACTIVO === -->
  <div class="col-12">
    <h5 class="mb-2">üí≥ M√©todo de pago</h5>
    <div id="metodo-pago" class="d-flex flex-wrap gap-2">
      <button type="button" class="btn btn-pago mp" data-pago="Mercado Pago">üíô Mercado Pago</button>
      <button type="button" class="btn btn-pago dni" data-pago="Cuenta DNI">üíö Cuenta DNI</button>
      <button type="button" class="btn btn-pago efectivo" data-pago="Efectivo">üíµ Efectivo</button>
    </div>
  </div>

  <!-- === LUGAR DE PAGO === -->
  <div class="col-12">
    <h5 class="mb-2 mt-3">üìç D√≥nde quer√©s pagar</h5>
    <div id="lugar-pago" class="d-flex flex-wrap gap-2">
      <button type="button" class="btn btn-lugar local" data-lugar="En el local">üè™ En el local</button>
      <button type="button" class="btn btn-lugar online" data-lugar="Online">üíª Online</button>
    </div>
  </div>

  <!-- ‚úÖ MENSAJE DE CONFIRMACI√ìN -->
  <p id="mensaje-confirmacion" class="text-success fw-bold mt-3" style="display:none;"></p>

  <!-- === NOTA OPCIONAL === -->
  <div class="col-12">
    <label class="form-label">Nota (opcional)</label>
    <textarea name="nota" class="form-control" rows="2" placeholder="Ej: sin cilantro, gracias"></textarea>
  </div>

  <!-- === RESUMEN DE PEDIDO === -->
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header bg-success text-white">Resumen</div>
      <div class="card-body">
        <ul class="list-group list-group-flush">
          {% for it in cart %}
          <li class="list-group-item d-flex justify-content-between">
            <span>{{ it.qty|fraccion }} {{ 'Kg' if it.unit=='kg' else 'u' }} {{ it.name }}</span>
            <strong>${{ '%.2f'|format(it.line_total) }}</strong>
          </li>
          <input type="hidden" name="qty_decimal_{{ loop.index0 }}" value="{{ it.qty }}">
          <input type="hidden" name="product_{{ loop.index0 }}" value="{{ it.name }}">
          <input type="hidden" name="unit_{{ loop.index0 }}" value="{{ it.unit }}">
          {% endfor %}
        </ul>
      </div>
      <div class="card-footer d-flex justify-content-between">
        <strong>Total</strong>
        <strong>${{ '%.2f'|format(total) }}</strong>
      </div>
    </div>
  </div>

  <!-- === BOTONES DE ACCI√ìN === -->
  <div class="col-12 text-end">
    <a class="btn btn-outline-secondary" href="{{ url_for('carrito') }}">Volver</a>
    <button class="btn btn-success" type="submit" disabled>Confirmar pedido</button>
  </div>

  <input type="hidden" name="pago_final" id="pago_final">
  <input type="hidden" name="cart_count" value="{{ cart|length }}">


</form>

<!-- === SCRIPT INTERACTIVO === -->
<script>
  // Funci√≥n para convertir decimales a fracciones
  function decimalAFraccion(decimal) {
    decimal = parseFloat(decimal);
    if (decimal === Math.round(decimal)) return Math.round(decimal).toString();
    
    const fracciones = {
      0.25: '1/4',
      0.5: '1/2',
      0.75: '3/4',
      0.33: '1/3',
      0.66: '2/3'
    };
    
    for (let [dec, frac] of Object.entries(fracciones)) {
      if (Math.abs(decimal - parseFloat(dec)) < 0.01) return frac;
    }
    
    const decimales = decimal.toString().split('.')[1]?.length || 0;
    const denominador = Math.pow(10, decimales);
    let numerador = Math.round(decimal * denominador);
    
    const gcd = (a, b) => b === 0 ? a : gcd(b, a % b);
    const divisor = gcd(numerador, denominador);
    
    numerador = numerador / divisor;
    const denom = denominador / divisor;
    
    if (denom === 1) return numerador.toString();
    return `${numerador}/${denom}`;
  }

  const botonesPago = document.querySelectorAll('.btn-pago');
  const botonesLugar = document.querySelectorAll('.btn-lugar');
  const mensaje = document.getElementById('mensaje-confirmacion');
  const botonConfirmar = document.querySelector('button[type="submit"]');
  const formulario = document.querySelector('form');

  let pagoSeleccionado = null;
  let lugarSeleccionado = null;

  function actualizarMensaje() {
    if (pagoSeleccionado && lugarSeleccionado) {
      mensaje.textContent = `‚úÖ Perfecto, pagar√°s con ${pagoSeleccionado} ${lugarSeleccionado.toLowerCase()}.`;
      mensaje.style.display = 'block';
      botonConfirmar.disabled = false;
    } else {
      mensaje.style.display = 'none';
      botonConfirmar.disabled = true;
    }

    document.getElementById("pago_final").value = `${pagoSeleccionado} - ${lugarSeleccionado}`;

  }

  botonesPago.forEach(b => {
    b.addEventListener('click', () => {
      botonesPago.forEach(x => x.classList.remove('active'));
      b.classList.add('active');
      pagoSeleccionado = b.dataset.pago;
      actualizarMensaje();
    });
  });

  botonesLugar.forEach(b => {
    b.addEventListener('click', () => {
      botonesLugar.forEach(x => x.classList.remove('active')); // CORRECCI√ìN: antes 'butonesLugar'
      b.classList.add('active');
      lugarSeleccionado = b.dataset.lugar;
      actualizarMensaje();
    });
  });

  // Convertir decimales a fracciones antes de enviar
  if (formulario) {
    formulario.addEventListener('submit', (e) => {
      e.preventDefault();
      const cartCount = parseInt(document.querySelector('input[name="cart_count"]').value || "0");
      for (let i = 0; i < cartCount; i++) {
        const inputDecimal = document.querySelector(`input[name="qty_decimal_${i}"]`);
        if (inputDecimal) {
          inputDecimal.value = decimalAFraccion(inputDecimal.value);
        }
      }
      formulario.submit();
    });
  } else {
    console.error("Formulario no encontrado: no se podr√° confirmar el pedido desde esta p√°gina.");
  }

  botonConfirmar.disabled = true;
</script>

{% else %}
<div class="alert alert-info">
  Tu carrito est√° vac√≠o. <a href="{{ url_for('index') }}">Volver al cat√°logo</a>
</div>
{% endif %}
{% endblock %}
